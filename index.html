<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>function2 by Naios</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>function2</h1>
        <h2>Improved alternative to std::function which supports move only types</h2>
        <a href="https://github.com/Naios/function2" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="c11-function-2---fu2" class="anchor" href="#c11-function-2---fu2" aria-hidden="true"><span class="octicon octicon-link"></span></a>C++11 Function 2 - fu2::</h1>

<p><a href="https://travis-ci.org/Naios/function2"><img src="https://travis-ci.org/Naios/function2.svg?branch=master" alt="Build Status"></a></p>

<p>Provides two improved implementations of <code>std::function</code>:</p>

<ul>
<li>
<strong>copyable</strong> <code>fu2::function</code>
</li>
<li>
<strong>move-only</strong> <code>fu2::unique_function</code>
</li>
</ul>

<p>which are:</p>

<ul>
<li>
<strong>const</strong>, <strong>volatile</strong> and <strong>reference</strong> correct (qualifiers are part of the <code>operator()</code> signature).</li>
<li>
<strong>convertible</strong> to and from <code>std::function</code>.</li>
<li>
<strong>adaptable</strong> through <code>fu2::function_base</code> (internal capacity, copyable).</li>
<li>
<strong>covered</strong> by unit tests and continuous integration.</li>
<li>
<strong>header only</strong>, just copy and include <code>function.hpp</code> in your project.</li>
</ul>

<h2>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of Contents</h2>

<ul>
<li>
<strong><a href="#documentation">Documentation</a></strong>

<ul>
<li><strong><a href="#how-to-use">How to use</a></strong></li>
<li><strong><a href="#constructing-a-function">Constructing a function</a></strong></li>
<li><strong><a href="#non-copyable-unique-functions">Non copyable unique functions</a></strong></li>
<li><strong><a href="#converbility-of-functions">Converbility of functions</a></strong></li>
<li><strong><a href="#adapt-function2">Adapt function2</a></strong></li>
</ul>
</li>
<li>
<strong><a href="#performance-and-optimization">Performance and optimization</a></strong>

<ul>
<li><strong><a href="#small-functor-optimization">Small functor optimization</a></strong></li>
<li><strong><a href="#compiler-optimization">Compiler optimization</a></strong></li>
<li><strong><a href="#stdfunction-vs-fu2function">std::function vs fu2::function</a></strong></li>
</ul>
</li>
<li><strong><a href="#coverage-and-runtime-checks">Coverage and runtime checks</a></strong></li>
<li><strong><a href="#compatibility">Compatibility</a></strong></li>
<li><strong><a href="#licence">License</a></strong></li>
<li><strong><a href="#similar-implementations">Similar implementations</a></strong></li>
</ul>

<h2>
<a id="documentation" class="anchor" href="#documentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Documentation</h2>

<h3>
<a id="how-to-use" class="anchor" href="#how-to-use" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to use</h3>

<p>Function2 is implemented in one header only file <code>function.hpp</code>, no compilation is required.
Just drop and include <code>function.hpp</code> to start!</p>

<p>Use <code>fu2::function</code> as a wrapper for copyable function wrappers and <code>fu2::unique_function</code> for move only types.
In most cases is <code>std::function</code> and <code>fu2::function</code> compatible, see <a href="#converbility-of-functions">the chapter converbility of functions</a> for details.</p>

<p>A function wrapper is declared as followed:</p>

<div class="highlight highlight-source-c++"><pre>fu2::function&lt;<span class="pl-k">void</span>(<span class="pl-k">int</span>, <span class="pl-k">float</span>) <span class="pl-k">const</span>&gt;
<span class="pl-c">// Return type ~^   ^     ^     ^</span>
<span class="pl-c">// Arguments ~~~~~~~|~~~~~|     ^</span>
<span class="pl-c">// Qualifier ~~~~~~~~~~~~~~~~~~~|</span></pre></div>

<h4>
<a id="return-type" class="anchor" href="#return-type" aria-hidden="true"><span class="octicon octicon-link"></span></a>Return type</h4>

<p>The return type of the function to wrap.</p>

<h4>
<a id="arguments" class="anchor" href="#arguments" aria-hidden="true"><span class="octicon octicon-link"></span></a>Arguments</h4>

<p>The argument types of the function to wrap.
Any argument types are allowed.</p>

<h4>
<a id="qualifiers" class="anchor" href="#qualifiers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Qualifiers</h4>

<p>There are several qualifiers allowed:</p>

<ul>
<li>
<strong>no qualifier</strong> provides <code>ReturnType operator() (Args...)</code>

<ul>
<li>Can be assigned from const and no const objects (<em>mutable lambdas</em> for example).</li>
</ul>
</li>
<li>
<strong>const</strong> provides <code>ReturnType operator() (Args...) const</code>

<ul>
<li>Requires that the assigned functor is const callable (won't work with <em>mutable lambdas</em>),</li>
</ul>
</li>
<li>
<strong>volatile</strong> provides <code>ReturnType operator() (Args...) volatile</code>

<ul>
<li>Can only be assigned from volatile qualified functors.</li>
</ul>
</li>
<li>
<strong>const volatile</strong> provides <code>ReturnType operator() (Args...) const volatile</code>

<ul>
<li>Same as const and volatile together.</li>
</ul>
</li>
<li>Also there is support for <strong>r-value functions</strong> <code>ReturnType operator() (Args...) &amp;&amp;</code>

<ul>
<li>one-shot functions which are invalidated after the first call.</li>
</ul>
</li>
</ul>

<h3>
<a id="constructing-a-function" class="anchor" href="#constructing-a-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Constructing a function</h3>

<p><code>fu2::function</code> and <code>fu2::unique_function</code> (non copyable) are easy to use:</p>

<div class="highlight highlight-source-c++"><pre>fu2::function&lt;<span class="pl-k">void</span>() <span class="pl-k">const</span>&gt; fun = []
{
    <span class="pl-c">// ...</span>
};

<span class="pl-c">// fun provides void operator()() const now</span>
<span class="pl-en">fun</span>();</pre></div>

<h3>
<a id="non-copyable-unique-functions" class="anchor" href="#non-copyable-unique-functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Non copyable unique functions</h3>

<p><code>fu2::unique_function</code> also works with non copyable functors/ lambdas.</p>

<div class="highlight highlight-source-c++"><pre>fu2::unique_function&lt;<span class="pl-k">bool</span>() <span class="pl-k">const</span>&gt; fun = [ptr = std::make_unique&lt;<span class="pl-k">bool</span>&gt;(<span class="pl-c1">true</span>)]
{
    <span class="pl-k">return</span> *ptr;
};

<span class="pl-c">// unique functions are move only</span>
fu2::unique_function&lt;<span class="pl-k">bool</span>() <span class="pl-k">const</span>&gt; otherfun = std::move(fun):

<span class="pl-en">otherfun</span>();</pre></div>

<h3>
<a id="converbility-of-functions" class="anchor" href="#converbility-of-functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Converbility of functions</h3>

<p><code>fu2::function</code>, <code>fu2::unique_function</code> and <code>std::function</code> are convertible to each other when:</p>

<ul>
<li>The return type and parameter type match.</li>
<li>The functions are both volatile or not.</li>
<li>The functions are const correct:

<ul>
<li><code>noconst = const</code></li>
<li><code>const = const</code></li>
<li><code>noconst = noconst</code></li>
</ul>
</li>
<li>The functions are copyable correct when:

<ul>
<li><code>unique = unique</code></li>
<li><code>unique = copyable</code></li>
<li><code>copyable = copyable</code></li>
</ul>
</li>
<li>The functions are reference correct when:

<ul>
<li><code>lvalue = lvalue</code></li>
<li><code>lvalue = rvalue</code></li>
<li><code>rvalue = rvalue</code></li>
</ul>
</li>
</ul>

<table>
<thead>
<tr>
<th>Cobvertible from \ to</th>
<th>fu2::function</th>
<th>fu2::unique_function</th>
<th>std::function</th>
</tr>
</thead>
<tbody>
<tr>
<td>fu2::function</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>fu2::unique_function</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>std::function</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>

<div class="highlight highlight-source-c++"><pre>fu2::function&lt;<span class="pl-k">void</span>()&gt; fun = []{};
<span class="pl-c">// OK</span>
std::function&lt;<span class="pl-k">void</span>()&gt; std_fun = fun;
<span class="pl-c">// OK</span>
fu2::unique_function&lt;<span class="pl-k">void</span>()&gt; un_fun = fun;

<span class="pl-c">// Error (non copyable -&gt; copyable)</span>
fun = un_fun;
<span class="pl-c">// Error (non copyable -&gt; copyable)</span>
fun = un_fun;
</pre></div>

<h3>
<a id="adapt-function2" class="anchor" href="#adapt-function2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adapt function2</h3>

<p>function2 is adaptable through <code>fu2::function_base</code> which allows you to set:</p>

<ul>
<li>
<strong>Signature:</strong> defines the signature of the function.</li>
<li>
<strong>Capacity:</strong> defines the internal capacity used for <a href="#small-functor-optimization">sfo optimization</a>.</li>
<li>
<strong>Copyable:</strong> defines if the function is copyable or not.</li>
</ul>

<p>The following code defines a function with a variadic signature which is copyable and sfo optimization is disabled:</p>

<div class="highlight highlight-source-c++"><pre><span class="pl-k">template</span>&lt;<span class="pl-k">typename</span> Signature&gt;
<span class="pl-k">using</span> my_function = fu2::function_base&lt;Signature, <span class="pl-c1">0UL</span>, <span class="pl-c1">true</span>&gt;;</pre></div>

<p>The following code defines a non copyable function which just takes 1 argument, and has a huge capacity for internal sfo optimization.
Also it must be called as r-value.</p>

<div class="highlight highlight-source-c++"><pre><span class="pl-k">template</span>&lt;<span class="pl-k">typename</span> Arg&gt;
<span class="pl-k">using</span> my_consumer = fu2::function_base&lt;<span class="pl-k">void</span>(Arg)&amp;&amp;, <span class="pl-c1">100UL</span>, <span class="pl-c1">false</span>&gt;;

<span class="pl-c">// Example</span>
my_consumer&lt;<span class="pl-k">int</span>, <span class="pl-k">float</span>&gt; consumer = [](<span class="pl-k">int</span>, <span class="pl-k">float</span>) { }
<span class="pl-en">std::move</span>(consumer)(<span class="pl-c1">44</span>, <span class="pl-c1">1</span>.<span class="pl-c1">7363f</span>);</pre></div>

<h2>
<a id="performance-and-optimization" class="anchor" href="#performance-and-optimization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Performance and optimization</h2>

<h3>
<a id="small-functor-optimization" class="anchor" href="#small-functor-optimization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Small functor optimization</h3>

<p>Function 2 uses small functor optimization like the most common std::function implementations which means it allocates a small internal capacity to evade heap allocation for small functors.</p>

<p>Smart heap allocation moves the inplace allocated functor automatically to the heap to speed up moving between objects.</p>

<p>It's possible to disable small functor optimization through setting the capacity to 0.</p>

<h3>
<a id="compiler-optimization" class="anchor" href="#compiler-optimization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compiler optimization</h3>

<p>Unique functions are heavily optimized by compilers see below:</p>

<div class="highlight highlight-source-c++"><pre><span class="pl-k">int</span> <span class="pl-en">main</span>(<span class="pl-k">int</span> argc, <span class="pl-k">char</span>**)
{
    fu2::unique_function&lt;<span class="pl-c1">int</span>()&gt; <span class="pl-c1">fun</span>([=]
    {
        <span class="pl-k">return</span> argc + <span class="pl-c1">10</span>;
    );
    <span class="pl-k">return</span> <span class="pl-c1">fun</span>() + <span class="pl-c1">fun</span>();
}</pre></div>

<p><a href="https://goo.gl/F7saQy">Clang 3.4+ with -O3 compiles it into</a>:</p>

<div class="highlight highlight-source-asm-x86"><pre>main: <span class="pl-c"># @main</span>
    <span class="pl-k">lea</span> <span class="pl-k">eax</span>, [rdi + rdi + <span class="pl-c1">20</span>]
    <span class="pl-k">ret</span></pre></div>

<p>(<code>std::function</code> <a href="https://goo.gl/GO4G4b">compiles into ~70 instructions</a>).</p>

<h3>
<a id="stdfunction-vs-fu2function" class="anchor" href="#stdfunction-vs-fu2function" aria-hidden="true"><span class="octicon octicon-link"></span></a>std::function vs fu2::function</h3>

<pre><code>Benchmark: Construct and copy function wrapper
    std::function:         172535130ns
    fu2::(unique)function: 112452593ns       +53%

Benchmark: Move function wrapper around
    std::function:         313446044ns
    fu2::(unique)function: 110743394ns       +183%

Benchmark: Invoke function wrapper
    std::function:         38555121ns
    fu2::(unique)function: 28355481ns        +35%
</code></pre>

<h2>
<a id="coverage-and-runtime-checks" class="anchor" href="#coverage-and-runtime-checks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Coverage and runtime checks</h2>

<p>Function2 is checked with unit tests and was tested with valgrind for memory leaks:</p>

<pre><code>===============================================================================
All tests passed (73 assertions in 7 test cases)

==15215== LEAK SUMMARY:
==15215==    definitely lost: 0 bytes in 0 blocks
==15215==    indirectly lost: 0 bytes in 0 blocks
==15215==      possibly lost: 0 bytes in 0 blocks
==15215==    still reachable: 72,704 bytes in 1 blocks
==15215==         suppressed: 0 bytes in 0 blocks
==15215==
==15215== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</code></pre>

<h2>
<a id="compatibility" class="anchor" href="#compatibility" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compatibility</h2>

<p>Tested with:</p>

<ul>
<li>Visual Studio 2015+</li>
<li>Clang 3.4+</li>
<li>GCC 4.8+</li>
</ul>

<p>Every compiler with full C++11 capability should work.
Function2 only depends on the standard library.</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Function2 is licensed under the Boost 1.0 License.</p>

<h2>
<a id="similar-implementations" class="anchor" href="#similar-implementations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Similar implementations</h2>

<ul>
<li><a href="https://github.com/potswa/cxx_function">potswa/cxx_function</a></li>
<li><a href="https://github.com/pmed/fixed_size_function">pmed/fixed_size_function</a></li>
<li><a href="http://probablydance.com/2013/01/13/a-faster-implementation-of-stdfunction">http://probablydance.com/2013/01/13/a-faster-implementation-of-stdfunction/</a></li>
</ul>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/Naios/function2/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/Naios/function2/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/Naios/function2"></a> is maintained by <a href="https://github.com/Naios">Naios</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
